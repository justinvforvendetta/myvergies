name: Patch MyVergies DMG (Replace Tor Binary + Codesign)

on:
  workflow_dispatch:

jobs:
  patch-dmg:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify inputs
        run: |
          echo "Repo contents:"
          ls -lah
          echo
          echo "Tor binary details:"
          ls -lah tor.real
          file tor.real

      - name: Convert DMG to writable
        run: |
          hdiutil convert myvergies.dmg \
            -format UDRW \
            -o myvergies-writable.dmg

      - name: Mount DMG
        run: |
          hdiutil attach myvergies-writable.dmg \
            -mountpoint /Volumes/MyVergiesRW

      - name: Copy app out of DMG
        run: |
          echo "Copying MyVergies.app out of DMG to workspace..."
          cp -R "/Volumes/MyVergiesRW/MyVergies.app" MyVergies.app

      - name: Verify Tor path inside copied app
        run: |
          TOR_DIR="MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor"
          TOR_PATH="$TOR_DIR/tor.real"

          echo "Listing Tor directory inside copied app:"
          ls -lah "$TOR_DIR"

          if [ ! -f "$TOR_PATH" ]; then
            echo "‚ùå Tor binary not found at expected path: $TOR_PATH"
            exit 1
          fi

          echo "‚úÖ Tor binary found"

      - name: Replace Tor binary
        run: |
          TOR_PATH="MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor/tor.real"

          echo "Removing old Tor binary..."
          rm -f "$TOR_PATH"

          echo "Copying new Tor binary from repo root..."
          cp tor.real "$TOR_PATH"

          echo "Setting executable permissions and clearing quarantine..."
          chmod 755 "$TOR_PATH"
          xattr -d com.apple.quarantine "$TOR_PATH" || true

      - name: Verify Tor replacement
        run: |
          TOR_PATH="MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor/tor.real"

          ls -lah "$TOR_PATH"
          file "$TOR_PATH"
          shasum -a 256 "$TOR_PATH"

      - name: Ad-hoc codesign Electron app (off-DMG)
        run: |
          APP="MyVergies.app"

          echo "üîß Removing existing signatures..."
          codesign --remove-signature "$APP" || true

          echo "üîß Signing all Mach-O binaries..."
          find "$APP" -type f -perm +111 | while read -r bin; do
            if file "$bin" | grep -q "Mach-O"; then
              echo "Signing Mach-O: $bin"
              codesign --force --sign - "$bin"
            fi
          done

          echo "üîß Signing framework bundles..."
          find "$APP/Contents/Frameworks" -name "*.framework" | while read -r fw; do
            echo "Signing framework: $fw"
            codesign --force --sign - "$fw"
          done

          echo "üîß Signing helper apps..."
          for helper in "$APP"/Contents/Frameworks/*Helper*.app; do
            echo "Signing helper: $helper"
            codesign --force --sign - "$helper"
          done

          echo "üîß Signing main app bundle..."
          codesign --force --sign - "$APP"

          echo "üîç Verifying signature..."
          codesign --verify --verbose=2 "$APP"

      - name: Unmount DMG
        run: |
          hdiutil detach /Volumes/MyVergiesRW

      - name: Rebuild DMG with signed app
        run: |
          hdiutil create \
            -volname "MyVergies" \
            -srcfolder MyVergies.app \
            -ov \
            -format UDZO \
            myvergies-patched.dmg

      - name: Upload patched DMG
        uses: actions/upload-artifact@v4
        with:
          name: myvergies-patched-dmg
          path: myvergies-patched.dmg
