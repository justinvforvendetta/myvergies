name: Patch MyVergies DMG (Replace Tor)

on:
  workflow_dispatch:

jobs:
  patch-dmg:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify inputs
        run: |
          ls -lah
          ls -lah bin/Tor
          file bin/Tor/tor.real

      - name: Convert DMG to writable
        run: |
          hdiutil convert myvergies.dmg \
            -format UDRW \
            -o myvergies-writable.dmg

      - name: Mount DMG
        run: |
          hdiutil attach myvergies-writable.dmg \
            -mountpoint /Volumes/MyVergiesRW

      - name: List DMG structure (important)
        run: |
          echo "==== DMG ROOT ===="
          ls -lah /Volumes/MyVergiesRW
          echo
          echo "==== APP BUNDLE TREE ===="
          find /Volumes/MyVergiesRW -maxdepth 5 -print

      - name: Locate Tor binary automatically
        id: find_tor
        run: |
          echo "Searching for Tor executable..."

          TOR_PATH=$(find /Volumes/MyVergiesRW \
            -type f \
            -perm +111 \
            \( -name "tor" -o -name "tor.real" \) \
            | head -n 1)

          if [ -z "$TOR_PATH" ]; then
            echo "❌ No Tor executable found"
            exit 1
          fi

          echo "✅ Found Tor at:"
          echo "  $TOR_PATH"
          echo "TOR_PATH=$TOR_PATH" >> $GITHUB_ENV

      - name: Replace Tor binary
        run: |
          echo "Replacing Tor at:"
          echo "  $TOR_PATH"

          chmod +w "$TOR_PATH"
          cp bin/Tor/tor.real "$TOR_PATH"
          chmod +x "$TOR_PATH"

      - name: Verify replacement
        run: |
          ls -lah "$TOR_PATH"
          file "$TOR_PATH"
          shasum -a 256 "$TOR_PATH"

      - name: Unmount DMG
        run: |
          hdiutil detach /Volumes/MyVergiesRW

      - name: Recompress DMG
        run: |
          hdiutil convert myvergies-writable.dmg \
            -format UDZO \
            -o myvergies-patched.dmg

      - name: Upload patched DMG
        uses: actions/upload-artifact@v4
        with:
          name: myvergies-patched-dmg
          path: myvergies-patched.dmg
