name: Patch MyVergies DMG (Replace Tor Binary)

on:
  workflow_dispatch:

jobs:
  patch-dmg:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify inputs
        run: |
          echo "Repo contents:"
          ls -lah
          echo
          echo "Tor binary details:"
          ls -lah tor.real
          file tor.real

      - name: Convert DMG to writable
        run: |
          hdiutil convert myvergies.dmg \
            -format UDRW \
            -o myvergies-writable.dmg

      - name: Mount DMG
        run: |
          hdiutil attach myvergies-writable.dmg \
            -mountpoint /Volumes/MyVergiesRW

      - name: Verify Tor target path exists inside DMG
        run: |
          TOR_DIR="/Volumes/MyVergiesRW/MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor"
          TOR_PATH="$TOR_DIR/tor.real"

          echo "Listing Tor directory inside DMG:"
          ls -lah "$TOR_DIR"

          if [ ! -f "$TOR_PATH" ]; then
            echo "‚ùå Existing tor.real not found at expected path:"
            echo "   $TOR_PATH"
            exit 1
          fi

          echo "‚úÖ Found existing Tor binary inside DMG"

      - name: Replace Tor binary
        run: |
          TOR_PATH="/Volumes/MyVergiesRW/MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor/tor.real"

          echo "Removing old Tor binary..."
          rm -f "$TOR_PATH"

          echo "Copying new Tor binary from repo root..."
          cp tor.real "$TOR_PATH"

          chmod 755 "$TOR_PATH"

      - name: Verify replacement
        run: |
          TOR_PATH="/Volumes/MyVergiesRW/MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor/tor.real"

          ls -lah "$TOR_PATH"
          file "$TOR_PATH"
          shasum -a 256 "$TOR_PATH"
          
      - name: Ad-hoc codesign app
        run: |
          APP="/Volumes/MyVergiesRW/MyVergies.app"

          echo "üîß Removing existing signatures..."
          codesign --remove-signature "$APP" || true

          echo "üîß Signing Electron Framework..."
          codesign --force --sign - \
            "$APP/Contents/Frameworks/Electron Framework.framework"

          echo "üîß Signing helper apps..."
          for helper in "$APP"/Contents/Frameworks/*Helper*.app; do
            echo "Signing $helper"
            codesign --force --sign - "$helper"
          done

          echo "üîß Signing remaining frameworks..."
          for fw in "$APP"/Contents/Frameworks/*.framework; do
            echo "Signing $fw"
            codesign --force --sign - "$fw"
          done

          echo "üîß Signing main app bundle..."
          codesign --force --sign - "$APP"

          echo "üîç Verifying signature..."
          codesign --verify --verbose=2 "$APP"

      - name: Unmount DMG
        run: |
          hdiutil detach /Volumes/MyVergiesRW

      - name: Recompress DMG
        run: |
          hdiutil convert myvergies-writable.dmg \
            -format UDZO \
            -o myvergies-patched.dmg

      - name: Upload patched DMG
        uses: actions/upload-artifact@v4
        with:
          name: myvergies-patched-dmg
          path: myvergies-patched.dmg
