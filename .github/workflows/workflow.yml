name: Patch MyVergies DMG (Replace Tor Binary)

on:
  workflow_dispatch:

jobs:
  patch-dmg:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify inputs
        run: |
          ls -lah
          ls -lah bin/Tor
          file bin/Tor/tor.real

      - name: Convert DMG to writable
        run: |
          hdiutil convert myvergies.dmg \
            -format UDRW \
            -o myvergies-writable.dmg

      - name: Mount DMG
        run: |
          hdiutil attach myvergies-writable.dmg \
            -mountpoint /Volumes/MyVergiesRW

      - name: Verify Tor target path exists
        run: |
          TOR_DIR="/Volumes/MyVergiesRW/MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor"
          TOR_PATH="$TOR_DIR/tor.real"

          echo "Checking Tor directory:"
          ls -lah "$TOR_DIR"

          if [ ! -f "$TOR_PATH" ]; then
            echo "❌ Existing tor.real not found at expected path:"
            echo "   $TOR_PATH"
            exit 1
          fi

          echo "✅ Found existing Tor binary"

      - name: Replace Tor binary
        run: |
          TOR_PATH="/Volumes/MyVergiesRW/MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor/tor.real"

          echo "Removing old Tor binary..."
          rm -f "$TOR_PATH"

          echo "Copying new Tor binary..."
          cp bin/Tor/tor.real "$TOR_PATH"

          chmod 755 "$TOR_PATH"

      - name: Verify replacement
        run: |
          TOR_PATH="/Volumes/MyVergiesRW/MyVergies.app/Contents/Resources/app.asar.unpacked/bin/Tor/tor.real"

          ls -lah "$TOR_PATH"
          file "$TOR_PATH"
          shasum -a 256 "$TOR_PATH"

      - name: Unmount DMG
        run: |
          hdiutil detach /Volumes/MyVergiesRW

      - name: Recompress DMG
        run: |
          hdiutil convert myvergies-writable.dmg \
            -format UDZO \
            -o myvergies-patched.dmg

      - name: Upload patched DMG
        uses: actions/upload-artifact@v4
        with:
          name: myvergies-patched-dmg
          path: myvergies-patched.dmg
